import{g as t}from"./p-2acb70a6.js";import{g as s}from"./p-796574a4.js";import{g as i}from"./p-b295a5ae.js";import{g as e,a as r,b as h}from"./p-8e7f4c22.js";import{L as n,a}from"./p-008d72ef.js";import{c as o}from"./p-b728aff4.js";import{b as u,u as c}from"./p-14a66e4a.js";import{f as l}from"./p-24ecdf64.js";import{U as g}from"./p-903ef8af.js";import{r as p}from"./p-dcdf7b57.js";function m(t,s,i){return void 0===i&&(i="https://www.arcgis.com/sharing/rest"),p(i+"/oauth2/exchangeToken",{method:"POST",params:{f:"json",client_id:s,token:t}}).then((function(t){return t.token}))}function f(t){let s;return t.match(/(qaext|\.mapsqa)\.arcgis.com/)?s="https://hubqa.arcgis.com":t.match(/(devext|\.mapsdevext)\.arcgis.com/)?s="https://hubdev.arcgis.com":t.match(/(www|\.maps)\.arcgis.com/)&&(s="https://hub.arcgis.com"),s}class d{constructor(t){this._portalUrl="https://www.arcgis.com",this._featureFlags={},this._userResourceTokens=[],this.id=t.id,this._portalUrl=t.portalUrl,this._hubUrl=t.hubUrl,this._serviceStatus=t.serviceStatus,t.authentication&&(this._authentication=t.authentication),t.portalSelf&&(this._portalSelf=t.portalSelf),t.currentUser&&(this._currentUser=t.currentUser),t.properties&&(this._properties=t.properties),t.trustedOrgIds&&(this._trustedOrgIds=t.trustedOrgIds),t.trustedOrgs&&(this._trustedOrgs=t.trustedOrgs),this._featureFlags=t.featureFlags||{},this._userResourceTokens=t.userResourceTokens||[]}get session(){return this._authentication}get isAuthenticated(){return!!this._authentication}get featureFlags(){return this._featureFlags}get isAlphaOrg(){var t,s;let i=!1;const e=(null===(t=this._properties)||void 0===t?void 0:t.alphaOrgs)||[],r=null===(s=this._portalSelf)||void 0===s?void 0:s.id;return e.length&&r&&(i=e.includes(r)),i}get isBetaOrg(){var t,s;let i=!1;const e=(null===(t=this._properties)||void 0===t?void 0:t.betaOrgs)||[],r=null===(s=this._portalSelf)||void 0===s?void 0:s.id;return e.length&&r&&(i=e.includes(r)),i}get environment(){return t(this._portalUrl)}get userRequestOptions(){if(this.isAuthenticated)return{authentication:this._authentication,portal:this.sharingApiUrl}}get requestOptions(){let t={portal:this.sharingApiUrl};return this.isAuthenticated&&(t={authentication:this._authentication,portal:this.sharingApiUrl}),t}get hubRequestOptions(){return{authentication:this.session,isPortal:this.isPortal,portalSelf:this.portal,hubApiUrl:this.hubUrl,portal:this.sharingApiUrl}}get portalUrl(){return this.isAuthenticated?this.isPortal||!this._portalSelf.urlKey?`https://${this._portalSelf.portalHostname}`:`https://${this._portalSelf.urlKey}.${this._portalSelf.customBaseUrl}`:this._portalUrl}get hubHomeUrl(){if(!this.isPortal){if(this.isAuthenticated){const t=this._hubUrl.replace("https://","");return`https://${this._portalSelf.urlKey}.${t}`}return this._hubUrl}}get hubLicense(){return this.isPortal?"enterprise-sites":this.hubEnabled?"hub-premium":"hub-basic"}get serviceStatus(){return this._serviceStatus}get sharingApiUrl(){return`${this.portalUrl}/sharing/rest`}get hubUrl(){return this._hubUrl}get isPortal(){return this._portalSelf?this._portalSelf.isPortal:-1===this._portalUrl.indexOf("arcgis.com")}get discussionsServiceUrl(){if(this._hubUrl)return`${this._hubUrl}/api/discussions/v1`}get hubSearchServiceUrl(){if(this._hubUrl)return`${this._hubUrl}/api/v3/datasets`}get domainServiceUrl(){if(this._hubUrl)return`${this._hubUrl}/api/v3/domains`}get eventsConfig(){if(this._portalSelf)return s(this._portalSelf,"portalProperties.hub.settings.events")}get hubEnabled(){return i(this._portalSelf,"portalProperties.hub.enabled",!1)}get communityOrgId(){if(this._portalSelf)return s(this._portalSelf,"portalProperties.hub.settings.communityOrg.orgId")}get communityOrgHostname(){if(this._portalSelf)return s(this._portalSelf,"portalProperties.hub.settings.communityOrg.portalHostname")}get communityOrgUrl(){if(this.communityOrgHostname)return`https://${this.communityOrgHostname}`}get helperServices(){if(this._portalSelf)return this._portalSelf.helperServices}get currentUser(){return this._currentUser}get portal(){return this._portalSelf}get properties(){return this._properties}get trustedOrgIds(){return this._trustedOrgIds}get trustedOrgs(){return this._trustedOrgs}get userResourceTokens(){return this._userResourceTokens}tokenFor(t){const s=this._userResourceTokens.find((s=>s.app===t));if(s)return s.token}}class b{constructor(t){this._portalUrl="https://www.arcgis.com",this._properties={},this._logLevel=n.error,this._featureFlags={},this._resourceConfigs=[],this._resourceTokens=[],this.id=(new Date).getTime(),t.logLevel&&(this._logLevel=t.logLevel),a.setLogLevel(this._logLevel),a.debug(`ArcGISContextManager:ctor: Creating ${this.id}`),t.properties&&(this._properties=t.properties),this._properties.alphaOrgs||(this._properties.alphaOrgs=[...O]),t.authentication?(this._authentication=t.authentication,this._portalUrl=this._authentication.portal.replace("/sharing/rest",""),this._hubUrl=f(this._portalUrl)):t.portalUrl?(this._portalUrl=t.portalUrl,this._hubUrl=f(this._portalUrl)):this._hubUrl=f(this._portalUrl),t.portal&&(this._portalSelf=o(t.portal)),t.currentUser&&(this._currentUser=o(t.currentUser)),t.serviceStatus&&(this._serviceStatus=t.serviceStatus),t.featureFlags&&(this._featureFlags=o(t.featureFlags)),t.trustedOrgIds&&(this._trustedOrgIds=o(t.trustedOrgIds)),t.trustedOrgs&&(this._trustedOrgs=o(t.trustedOrgs)),t.resourceConfigs&&(this._resourceConfigs=t.resourceConfigs),t.resourceTokens&&(this._resourceTokens=t.resourceTokens)}static async create(t={}){const s=new b(t);return await s.initialize(),s}static async deserialize(t){const s=u(t),i=JSON.parse(s),e={portalUrl:i.portalUrl};if(i.session){const t=g.deserialize(i.session);t.tokenExpires.getTime()>Date.now()&&(e.authentication=t,i.portal&&(e.portal=i.portal),i.currentUser&&(e.currentUser=i.currentUser),i.properties&&(e.properties=i.properties),i.trustedOrgIds&&(e.trustedOrgIds=i.trustedOrgIds),i.trustedOrgs&&(e.trustedOrgs=i.trustedOrgs))}else e.portalUrl=i.portalUrl;return e.serviceStatus=i.serviceStatus,e.featureFlags=i.featureFlags,e.resourceConfigs=i.resourceConfigs,e.resourceTokens=i.resourceTokens,b.create(e)}async setAuthentication(t){this._authentication=t,this._portalUrl=t.portal.replace("/sharing/rest",""),await this.initialize()}setProperties(t){this._properties=t,this._context=new d(this.contextOpts)}clearAuthentication(){this._context.isPortal||(this._portalUrl=e(this._portalUrl)),this._authentication=null,this._portalSelf=null,this._currentUser=null,this._resourceTokens=[],this._context=new d(this.contextOpts)}get context(){return this._context}serialize(){const t={portalUrl:this._portalUrl,serviceStatus:this._serviceStatus,featureFlags:this._featureFlags,properties:this._properties,resourceConfigs:this._resourceConfigs,resourceTokens:this._resourceTokens};return this._authentication&&(t.session=this._authentication.serialize()),this._portalSelf&&(t.portal=this._portalSelf),this._currentUser&&(t.currentUser=this._currentUser),this._trustedOrgIds&&(t.trustedOrgIds=this._trustedOrgIds),this._trustedOrgs&&(t.trustedOrgs=this._trustedOrgs),c(JSON.stringify(t))}async initialize(){const t=[],s=[];if(this._serviceStatus||(t.push(function(t){let s=v;return-1===t.indexOf("arcgis.com")&&(s=w),Promise.resolve(s)}(this._portalUrl)),s.push("serviceStatus")),this._authentication){const i=await this._authentication.getToken(this._authentication.portal);this._portalSelf||(t.push(r({authentication:this._authentication})),s.push("portal")),this._currentUser||(t.push(h({username:this._authentication.username,authentication:this._authentication})),s.push("user")),this._trustedOrgs||(t.push(async function(t,s){const i=l(p,{trustedOrgs:[]});return(await i(`${t}/sharing/rest/portals/self/trustedOrgs?f=json`,{params:{token:s.token}})).trustedOrgs}(this._portalUrl,this._authentication)),s.push("trustedOrgs")),!this._resourceTokens.length&&this._resourceConfigs.length&&(t.push(async function(t,s,i){const e=l(m,null),r=t.map((t=>e(s,t.clientId,i).then((s=>{if(s)return Object.assign(Object.assign({},t),{token:s})}))));return Promise.all(r)}(this._resourceConfigs,i,this._portalUrl+"/sharing/rest")),s.push("tokens")),this._resourceTokens.push({app:"self",token:i,clientId:this._authentication.clientId||"self"})}let i;try{i=await Promise.all(t)}catch(t){const s=`ArcGISContextManager failed while initializing for "${this._authentication.username}" using ${this._authentication.portal}.`;throw a.error(s),console.error(s),t}s.forEach(((t,s)=>{const e=i[s];switch(t){case"portal":this._portalSelf=e;break;case"user":this._currentUser=e;break;case"trustedOrgs":this._trustedOrgs=e,this._trustedOrgIds=this._trustedOrgs.map((t=>t.to.orgId));break;case"tokens":this._resourceTokens=[...this._resourceTokens,...e];break;case"serviceStatus":this._serviceStatus=e}})),a.debug(`ArcGISContextManager-${this.id}: updating context`),this._context=new d(this.contextOpts)}get contextOpts(){const t={id:this.id,portalUrl:this._portalUrl,hubUrl:this._hubUrl,properties:this._properties,serviceStatus:this._serviceStatus,featureFlags:this._featureFlags};return this._authentication&&(t.authentication=this._authentication),this._portalSelf&&(t.portalSelf=this._portalSelf),this._currentUser&&(t.currentUser=this._currentUser),this._trustedOrgIds&&(t.trustedOrgIds=this._trustedOrgIds),this._trustedOrgs&&(t.trustedOrgs=this._trustedOrgs),t.userResourceTokens=this._resourceTokens,t}}const v={portal:"online",discussions:"online",events:"online",metrics:"online",notifications:"online","hub-search":"online",domains:"online"},w={portal:"online",discussions:"not-available",events:"not-available",metrics:"not-available",notifications:"not-available","hub-search":"not-available",domains:"not-available"},O=["gGHDlz6USftL5Pau","CrA5hYOKgL3Vwan8","zj227gjeSqEyG4HF","bkrWlSKcjUDFDtgw","97KLIFOSt5CxbiRI","MiFBHFxEZWumnKCx","8HRYeOqprj872mxP","Xj56SBi2udA78cC9","LjjARY1mkhxulWPq","q2ikdtW0bkt5EgtQ","yHYVvboBBOdmcKci"];export{b as A}