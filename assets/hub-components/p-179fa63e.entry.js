import{r as t,h as s,F as e,H as i,a as r}from"./p-d4ba4c14.js";import{i as o}from"./p-be5c5009.js";import"./p-d8c815da.js";import"./p-4c02fe5e.js";import"@arcgis/core/kernel.js";import"./p-2d862ad3.js";import"./p-35a4fa90.js";import"./p-c81c6bb9.js";import{g as a}from"./p-81a9bee2.js";import{C as n}from"./p-d86e4f15.js";import{b as p}from"./p-fd260f2d.js";import{p as l,g as c,a as h}from"./p-79bb36a5.js";import{g as d}from"./p-75d6da59.js";import{c as m}from"./p-f845584b.js";import{c as u}from"./p-b728aff4.js";import{h as b}from"./p-b1a98ae3.js";import{H as f}from"./p-bb9bfd65.js";import{r as g}from"./p-7853d817.js";import"./p-dfe5a97d.js";import"./p-859c5360.js";import"./p-d763eacf.js";import"./p-377e1b5e.js";import"./p-637ea136.js";import"./p-dcdf7b57.js";import"./p-24ecdf64.js";import"./p-a0deb8c6.js";import"./p-7b082f5d.js";import"./p-8dbea197.js";import"./p-b295a5ae.js";import"./p-796574a4.js";import"./p-9b205605.js";import"./p-1458dcfd.js";import"./p-783242bc.js";import"./p-dd26efbb.js";import"./p-d1b12a9c.js";import"./p-6dcae6cd.js";import"./p-3f64a9d9.js";import"./p-2acb70a6.js";import"./p-903ef8af.js";import"./p-52612356.js";import"./p-af59e67b.js";import"./p-85d6867e.js";import"./p-6f931af6.js";import"./p-56b73d71.js";import"./p-3904125b.js";import"./p-cea8413b.js";import"./p-ad325ed1.js";import"./p-8e7f4c22.js";import"./p-69555c48.js";import"./p-7202c430.js";import"./p-90dc0f6f.js";import"./p-59fd2498.js";import"./p-16a95e5b.js";import"./p-e43616ff.js";import"./p-ca048216.js";import"./p-4a14259a.js";import"./p-235bb6ee.js";import"./p-c836a9b6.js";import"./p-dafb2329.js";import"./p-992b9d10.js";import"./p-895b662f.js";import"./p-31aebb8c.js";import"./p-aa262d60.js";import"./p-ea6de7f6.js";import"./p-3363f483.js";import"./p-87582fe0.js";import"./p-94a4bb53.js";import"./p-a7af8413.js";var j;!function(t){t.FOLLOWERS="Followers",t.SETTINGS="Followers Settings"}(j||(j={}));const w=class{constructor(s){t(this,s),this.handleTabActivated=t=>{this.activeTab=t.target.tab},this.entity=void 0,this.activeTab=j.FOLLOWERS,this.followersCount=void 0,this.newFollowersCount=void 0,this.footerSlotEl=void 0,this.isUserPickerOpen=!1,p(this,"handlePickerOpen","handlePickerClose","handlePickerSelectionUpdate","handleGalleryBulkAction")}async componentWillLoad(){this.intl=await o.loadIntlForComponent(this.element),this.fetchStats(),this.fetchFollowersGroup()}handlePickerOpen(){this.isUserPickerOpen=!0}handlePickerClose(){this.isUserPickerOpen=!1}get _context(){return a()}get followersGroupId(){var t;return null===(t=this.entity)||void 0===t?void 0:t.followersGroupId}get entityType(){return d(this.entity)}get isMember(){return m("hub:site:workspace:followers:member",this._context,this.entity).access}get isManager(){return m("hub:site:workspace:followers:manager",this._context,this.entity).access}get tabConfigurations(){return[{title:this.intl.t("tabs.followers"),key:j.FOLLOWERS,permissions:["hub:site:workspace:followers:member"],content:this.renderFollowersTab()},{title:this.intl.t("tabs.settings"),key:j.SETTINGS,permissions:["hub:site:workspace:followers:manager"],content:this.renderSettingsTab()}].filter((t=>t.permissions.every((t=>m(t,this._context,this.entity).access))))}get query(){return{targetEntity:"groupMember",filters:[{predicates:[{group:this.followersGroupId}]}]}}get bulkActions(){const t={actions:[]};return this.isManager&&t.actions.push({name:"removeUsers",icon:"user-minus",text:this.intl.t("removeUsers.button")}),t}async fetchStats(){const t=u(this.query),s=(new Date).getDate();t.filters[0].predicates[0].joined={type:"date-range",from:new Date((new Date).setDate(s-30)).valueOf(),to:(new Date).valueOf()};const[e,i]=await Promise.all([b(this.query,{requestOptions:this._context.hubRequestOptions}),b(t,{requestOptions:this._context.hubRequestOptions})]);this.followersCount=e.total,this.newFollowersCount=i.total}async fetchFollowersGroup(){this.followersGroup=(await f.fetch(this.followersGroupId,this._context)).toJson()}get pickerCatalogDefinition(){return l}get pickerFacets(){return c(this.followersGroup,this._context,this.intl)}async handlePickerSelectionUpdate(t){var s,e;const{communityUser:i}=t.detail;try{const t=await h(this.followersGroupId,i,this._context.userRequestOptions,m("platform:portal:admin:assignToGroups",this._context).access);let e=this.intl.t("addMembers.notifications.invited");t.added.length&&(e=this.intl.t("addMembers.notifications.added")),t.notInvited.length&&(e=this.intl.t("addMembers.notifications.notInvited")),null===(s=this.workspacePane)||void 0===s||s.triggerAlert({kind:t.notAdded.length&&t.notInvited.length?"danger":"success",title:e}),this.fetchStats()}catch(t){console.error("Something went wrong adding users to the group",t),null===(e=this.workspacePane)||void 0===e||e.triggerAlert({kind:"danger",title:this.intl.t("addMembers.notifications.notInvited")})}}async handleGalleryBulkAction(t){const{action:s,selection:e}=t.detail;switch(s.name){case"removeUsers":this.removeUsersFromGroup(e)}}async removeUsersFromGroup(t){var s,e,i,r;try{const r=await g(Object.assign({id:this.followersGroupId,users:t},this._context.userRequestOptions));null===(s=this.memberGallery)||void 0===s||s.refresh(),null===(e=this.memberGallery)||void 0===e||e.clearSelection(),this.fetchStats(),null===(i=this.workspacePane)||void 0===i||i.triggerAlert({kind:r.notRemoved.length?"danger":"success",title:r.notRemoved.length?this.intl.t("removeUsers.error"):this.intl.t("removeUsers.success",{groupName:this.entity.name})})}catch(t){console.error("Something went wrong removing users from the group",t),null===(r=this.workspacePane)||void 0===r||r.triggerAlert({kind:"danger",title:this.intl.t("removeUsers.error")})}}renderTabs(){return s("calcite-tabs",null,s("calcite-tab-nav",{onCalciteTabsActivate:this.handleTabActivated,slot:"title-group"},this.tabConfigurations.map((t=>s("calcite-tab-title",{key:t.key,selected:this.activeTab===t.key,tab:t.key},t.title)))),this.tabConfigurations.map((t=>s("calcite-tab",{class:"content-tab-container",key:t.key,selected:this.activeTab===t.key,tab:t.key},t.content))))}renderFollowersTab(){return s("div",{class:"entity-followers__tab"},this.isManager&&s("div",{slot:"primary-actions"},this.renderUserPicker()),this.renderFollowersGroup())}renderSettingsTab(){return s("arcgis-hub-entity-editor",{context:this._context,editorType:`hub:${this.entityType}:followers`,entity:this.entity,footerSlotRef:this.footerSlotEl,include:["followersGroup.access AS _followers.groupAccess"],variant:n.workspace})}renderEmptyState(){return s("h3",null,this.intl.t("emptyState.message"))}renderRestrictedAccessState(){return s("h3",null,this.intl.t("restrictedAccessState.message"))}renderFollowersGroup(){return s(e,null,this.renderStats(),this.renderGallery())}renderStats(){return s("div",{class:"entity-followers__stats"},s("arcgis-stat-card",{cardTitle:this.intl.t("stats.total.title"),key:"total",trailingText:this.intl.t("stats.total.trailingText"),value:this.followersCount&&this.intl.formatNumber(this.followersCount)}),s("arcgis-stat-card",{cardTitle:this.intl.t("stats.new.title"),key:"new",trailingText:this.intl.t("stats.new.trailingText"),value:this.newFollowersCount&&this.intl.formatNumber(this.newFollowersCount)}))}renderGallery(){return s("arcgis-hub-gallery",{bulkActions:this.bulkActions,context:this._context,onArcgisHubGalleryBulkAction:this.handleGalleryBulkAction,query:this.query,ref:t=>{this.memberGallery=t},selectionMode:this.isManager?"multiple":"none",showBackToTopBtn:!0,showBadges:!0,showLayoutSwitcher:!0,showMoreResultsBtn:!0,showResultsCount:!0,showSearch:!0,showSort:!0,sortField:"username",sortOptions:["username","joined","memberType"]})}renderUserPicker(){if(m("hub:group:edit",this._context,this.entity).access)return s(e,null,s("div",{class:"picker-button-container"},s("calcite-button",{appearance:"outline-fill",onClick:this.handlePickerOpen,round:!0},this.intl.t("addMembers.button"))),this.isUserPickerOpen&&s("arcgis-wormhole",{elAttributes:{unthemed:""}},s("arcgis-hub-gallery-picker",{catalogs:[this.pickerCatalogDefinition],context:this._context,facets:this.pickerFacets,limit:10,modalTitle:this.intl.t("addMembers.modal.title"),onArcgisHubGalleryPickerClose:this.handlePickerClose,onArcgisHubGalleryPickerSelectionUpdate:this.handlePickerSelectionUpdate,open:this.isUserPickerOpen,showBadges:!1,showSearch:!0,showThumbnail:!0,sortField:"username",sortOptions:["username","joined"]})))}render(){return s(i,{"data-element":"entity-followers"},s("arcgis-hub-workspace-pane",{ref:t=>{this.workspacePane=t},stickyFooter:!0},s("h2",{slot:"title"},this.intl.t("followers")),this.followersGroupId?this.isMember?this.renderTabs():this.renderRestrictedAccessState():this.renderEmptyState(),this.activeTab===j.SETTINGS&&s("div",{ref:t=>{this.footerSlotEl=t},slot:"footer"})))}static get assetsDirs(){return["locales"]}get element(){return r(this)}};w.style=":host{display:block;height:100%}.entity-followers__tab{display:flex;flex-direction:column;gap:2rem}calcite-tabs{gap:0px}.entity-followers__stats{display:flex;width:100%;gap:1rem}.entity-followers__stats arcgis-stat-card{width:50%}";export{w as arcgis_hub_entity_followers}