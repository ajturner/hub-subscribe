/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var e=function(r,t){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(r,t)},r=function(){return(r=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e}).apply(this,arguments)};function t(e){return Object.keys(e).some((function(r){var t=e[r];if(!t)return!1;switch(t&&t.toParam&&(t=t.toParam()),t.constructor.name){case"Array":case"Object":case"Date":case"Function":case"Boolean":case"String":case"Number":return!1;default:return!0}}))}function n(e){var r={};return Object.keys(e).forEach((function(t){var n,o,i=e[t];if(i&&i.toParam&&(i=i.toParam()),i||0===i||"boolean"==typeof i||"string"==typeof i){var a;switch(i.constructor.name){case"Array":var u=null===(o=null===(n=i[0])||void 0===n?void 0:n.constructor)||void 0===o?void 0:o.name;a="Array"===u?i:"Object"===u?JSON.stringify(i):i.join(",");break;case"Object":a=JSON.stringify(i);break;case"Date":a=i.valueOf();break;case"Function":a=null;break;case"Boolean":a=i+"";break;default:a=i}(a||0===a||"string"==typeof a||Array.isArray(a))&&(r[t]=a)}})),r}function o(e,r){return Array.isArray(r)&&r[0]&&Array.isArray(r[0])?r.map((function(r){return o(e,r)})).join("&"):encodeURIComponent(e)+"="+encodeURIComponent(r)}function i(e){var r=n(e);return Object.keys(r).map((function(e){return o(e,r[e])})).join("&")}var a=function(e,r,t,n,o){e=e||"UNKNOWN_ERROR",r=r||"UNKNOWN_ERROR_CODE",this.name="ArcGISRequestError",this.message="UNKNOWN_ERROR_CODE"===r?e:r+": "+e,this.originalMessage=e,this.code=r,this.response=t,this.url=n,this.options=o};(a.prototype=Object.create(Error.prototype)).constructor=a;var u="@esri/arcgis-rest-js",c={httpMethod:"POST",params:{f:"json"}},s=function(t){function n(e,r,n,o,i){void 0===e&&(e="AUTHENTICATION_ERROR"),void 0===r&&(r="AUTHENTICATION_ERROR_CODE");var a=t.call(this,e,r,n,o,i)||this;return a.name="ArcGISAuthError",a.message="AUTHENTICATION_ERROR_CODE"===r?e:r+": "+e,a}return function(r,t){function n(){this.constructor=r}e(r,t),r.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}(n,t),n.prototype.retry=function(e,t){var n=this;void 0===t&&(t=3);var o=0,i=function(a,u){e(n.url,n.options).then((function(e){var t=r(r({},n.options),{authentication:e});return o+=1,f(n.url,t)})).then((function(e){a(e)})).catch((function(e){"ArcGISAuthError"===e.name&&o<t?i(a,u):u("ArcGISAuthError"===e.name&&o>=t?n:e)}))};return new Promise((function(e,r){i(e,r)}))},n}(a);function f(e,o){void 0===o&&(o={params:{f:"json"}});var u=r(r(r({httpMethod:"POST"},c),o),{params:r(r({},c.params),o.params),headers:r(r({},c.headers),o.headers)}),f=[],d=[];if(u.fetch||"undefined"==typeof fetch?(f.push("`fetch`"),d.push("`node-fetch`")):u.fetch=fetch.bind(Function("return this")()),"undefined"==typeof Promise&&(f.push("`Promise`"),d.push("`es6-promise`")),"undefined"==typeof FormData&&(f.push("`FormData`"),d.push("`isomorphic-form-data`")),!u.fetch||"undefined"==typeof Promise||"undefined"==typeof FormData)throw new Error("`arcgis-rest-request` requires a `fetch` implementation and global variables for `Promise` and `FormData` to be present in the global scope. You are missing "+f.join(", ")+". We recommend installing the "+d.join(", ")+" modules at the root of your application to add these to the global scope. See https://bit.ly/2KNwWaJ for more info.");var h=u.httpMethod,l=u.authentication,O=u.rawResponse,v=r({f:"json"},u.params),m=null,p={method:h,credentials:u.credentials||"same-origin"};return u.headers&&u.headers["X-Esri-Auth-Client-Id"]&&e.indexOf("/oauth2/platformSelf")>-1&&(p.credentials="include"),(l?l.getToken(e,{fetch:u.fetch}).catch((function(r){return r.url=e,r.options=u,m=r,Promise.resolve("")})):Promise.resolve("")).then((function(o){o.length&&(v.token=o),l&&l.getDomainCredentials&&(p.credentials=l.getDomainCredentials(e));var a={};if("GET"===p.method){v.token&&u.hideToken&&"undefined"==typeof window&&(a["X-Esri-Authorization"]="Bearer "+v.token,delete v.token);var c=""===i(v)?e:e+"?"+i(v);u.maxUrlLength&&c.length>u.maxUrlLength||v.token&&u.hideToken?(p.method="POST",o.length&&u.hideToken&&(v.token=o,delete a["X-Esri-Authorization"])):e=c}var s=new RegExp("/items/.+/updateResources").test(e);return"POST"===p.method&&(p.body=function(e,r){var o=t(e)||r,a=n(e);if(o){var u=new FormData;return Object.keys(a).forEach((function(e){"undefined"!=typeof Blob&&a[e]instanceof Blob?u.append(e,a[e],a.fileName||a[e].name||e):u.append(e,a[e])})),u}return i(e)}(v,s)),p.headers=r(r({},a),u.headers),"undefined"!=typeof window||p.headers.referer||(p.headers.referer="@esri/arcgis-rest-js"),t(v)||s||(p.headers["Content-Type"]="application/x-www-form-urlencoded"),u.fetch(e,p)})).then((function(r){if(!r.ok)throw new a(r.statusText,"HTTP "+r.status,r,e,u);if(O)return r;switch(v.f){case"json":case"geojson":return r.json();case"html":case"text":return r.text();default:return r.blob()}})).then((function(r){if("json"!==v.f&&"geojson"!==v.f||O)return r;var t=function(e,r,t,n,o){if(e.code>=400)throw new a(u=e.message,c=e.code,e,r,n);if(e.error){var i=e.error,u=i.message,c=i.code,f=i.messageCode,d=f||c||"UNKNOWN_ERROR_CODE";if(498===c||499===c||"GWM_0003"===f||400===c&&"Unable to generate token."===u)throw o||new s(u,d,e,r,n);throw new a(u,d,e,r,n)}if("failed"===e.status||"failure"===e.status){u=void 0,c="UNKNOWN_ERROR_CODE";try{u=JSON.parse(e.statusMessage).message,c=JSON.parse(e.statusMessage).code}catch(r){u=e.statusMessage||e.message}throw new a(u,c,e,r,n)}return e}(r,e,0,u,m);if(m){var n=e.toLowerCase().split(/\/rest(\/admin)?\/services\//)[0];u.authentication.federatedServers[n]={token:[],expires:new Date(Date.now()+864e5)},m=null}return t}))}export{s as A,u as N,r as _,i as e,f as r}