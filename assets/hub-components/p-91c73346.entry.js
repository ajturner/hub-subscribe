import{r as i,c as t,h as e,F as s,H as o,a}from"./p-d4ba4c14.js";import{b as r}from"./p-fd260f2d.js";import{C as n}from"./p-1fde1b24.js";import c from"@arcgis/core/layers/GraphicsLayer.js";import{d as h,a as l,s as d,S as p}from"./p-a5a61c3e.js";import{project as v}from"@arcgis/core/geometry/support/webMercatorUtils.js";import{g as u}from"./p-e16232c9.js";import m from"@arcgis/core/Graphic.js";import{i as g}from"./p-be5c5009.js";import b from"@arcgis/core/geometry/Polygon.js";import w from"@arcgis/core/geometry/SpatialReference.js";import y from"@arcgis/core/geometry/Extent.js";import{g as x,a as f,b as k}from"./p-e07eb8b2.js";import{d as j}from"./p-8cf4bd83.js";import{b as _,c as L}from"./p-d1b12a9c.js";import"@arcgis/core/geometry/geometryEngine.js";import"./p-4c02fe5e.js";import"./p-dfe5a97d.js";import"@arcgis/core/kernel.js";import"./p-796574a4.js";import"./p-dcdf7b57.js";const O=["point","polyline","polygon","rectangle"],C=class{constructor(e){i(this,e),this.arcgisHubLocationPickerUpdate=t(this,"arcgisHubLocationPickerUpdate",7),this.arcgisHubMapPopoverOpen=t(this,"arcgisHubMapPopoverOpen",7),this.arcgisHubMapPopoverClear=t(this,"arcgisHubMapPopoverClear",7),this.hubTelemetry=t(this,"hubTelemetry",7),this.handles=[],this._drawToolIcons={point:"pin",polyline:"freehand",polygon:"freehand-area",rectangle:"rectangle-area"},this.options=void 0,this.extent=void 0,this.mapTools=O,this.theme={},this.resetDrawingToolsOnDisconnect=!0,this.maxVerticesCount=60,this.maxFeaturesCount=10,this._selected=void 0,this._view=void 0,this._editingGraphic=void 0,this._isEditing=!1,this._currentDrawTools=this.mapTools,this._currentActiveDrawTool=void 0,r(this,"_setMapDrawElement","handleViewPointerMoveOrDown","handleViewPointerLeave","editFeature","removeFeature","renderEditOptions","setActiveLocationDrawType","clearEditState")}get _selectedType(){var i,t;return null===(t=null===(i=this._selected)||void 0===i?void 0:i.location)||void 0===t?void 0:t.type}get _shouldEditFeatures(){return["custom"].includes(this._selectedType)}get _selectedOption(){var i;return null===(i=this.options)||void 0===i?void 0:i.find((i=>i.selected))}get _showExtent(){return["item","org"].find((i=>i===this._selectedType))}get _selectedExtentGraphic(){var i,t,e,s;return[{symbol:x(),geometry:Object.assign({type:"extent",spatialReference:null===(t=null===(i=this._selected)||void 0===i?void 0:i.location)||void 0===t?void 0:t.spatialReference},_(null===(s=null===(e=this._selected)||void 0===e?void 0:e.location)||void 0===s?void 0:s.extent))}]}get _selectedGraphics(){if(this._showExtent)return this._selectedExtentGraphic}_setMapDrawElement(i){this._mapDrawToolsEl=i}get themeWithDefaults(){const{theme:i}=this,t={};return["extent","point","polyline","polygon"].forEach((e=>{t[e]=Object.assign(Object.assign({},h[e]),i[e])})),t}async componentWillLoad(){this.intl=await g.loadIntlForComponent(this.el),this.onOptionsUpdate(),this.addWatchHandles()}connectedCallback(){this.addWatchHandles()}disconnectedCallback(){this.removeWatchHandles()}addWatchHandles(){const{_view:i,handles:t}=this;i&&(t.push(this._view.on(["pointer-move","pointer-down"],this.handleViewPointerMoveOrDown)),t.push(this._view.on("pointer-leave",this.handleViewPointerLeave)))}removeWatchHandles(){const{handles:i}=this;i.forEach((i=>{i.remove()})),this.handles=[]}handleViewChange(i,t){i&&i!==t&&(this.removeWatchHandles(),this.addWatchHandles())}async onOptionsUpdate(){var i,t;this._selected=Object.assign({},this._selectedOption),this._shouldEditFeatures?await this._initializeGraphicsLayer():!this._showExtent||(null===(i=this._selected.location)||void 0===i?void 0:i.geometries)&&(null===(t=this._selected.location)||void 0===t?void 0:t.geometries.length)||(this._updateSelectedLocationExtentToGeometry(),this._emitLocationWithFallback())}async handleMapViewReady(i){i.stopPropagation();const{detail:{view:t}}=i;await t.when(),t.ui.components=[],this._view=t,this._shouldEditFeatures&&await this._initializeGraphicsLayer()}async handleListItemSelect(i){i.stopPropagation();const t=this.options[i.target.value];t.location.type!==this._selectedType&&(this._shouldEditFeatures&&(this._destroyLayers(),this.arcgisHubMapPopoverClear.emit(),this._mapDrawToolsEl.forceReset(),this._resetToolsAndEditState(!0)),this._selected=Object.assign(Object.assign({},t),{selected:!0}),this._shouldEditFeatures&&await this._initializeGraphicsLayer(),this._showExtent&&this._updateSelectedLocationExtentToGeometry(),this._emitLocationWithFallback(),this.hubTelemetry.emit(Object.assign(Object.assign({},j.dictionary.category.interaction.action.select),{label:t.label})))}handleGraphicsChange(i){var t;const{detail:{graphics:e,save:s,unsaved:o,canceled:a}}=i,r=e.getItemAt(0),n=r.geometry.clone();r.geometry="extent"===n.type?n:l(r.geometry.clone(),this._view),o||s?(this._mapDrawToolsEl.forceReset(),r.symbol=d[r.geometry.type](p.DEFAULT,this.themeWithDefaults[r.geometry.type]),this._addGraphicsToGraphicsLayer(this.geometryGraphicsLayer,[r]),this._updateSelectedLocation(),f(null===(t=this._selected)||void 0===t?void 0:t.location)<=this.maxVerticesCount&&this.arcgisHubLocationPickerUpdate.emit(this._selected.location),this.arcgisHubMapPopoverClear.emit(),this._resetToolsAndEditState(),this._isEditing=!1):a&&(this._mapDrawToolsEl.forceReset(),this._addGraphicsToGraphicsLayer(this.geometryGraphicsLayer,[this._editingGraphic]),this.arcgisHubMapPopoverClear.emit(),this.arcgisHubLocationPickerUpdate.emit(this._selected.location),this._resetToolsAndEditState())}handleDrawToolSelection(i){i.preventDefault();const t=i.detail;this._isEditing=!0,t&&(this._currentDrawTools=[t],this._currentActiveDrawTool=t)}handleViewPointerMoveOrDown(i){const{_view:t,geometryGraphicsLayer:e}=this;this._shouldEditFeatures&&t.hitTest(i,{include:e}).then((i=>{const e=u(i.results);e&&!this._isEditing&&(this._editingGraphic=e.graphic,this.arcgisHubMapPopoverOpen.emit({source:"location-picker-options",geometry:e.graphic.geometry,view:t,render:this.renderEditOptions}))}))}handleViewPointerLeave(i){var t;i.stopPropagation(),"ARCGIS-HUB-MAP-POPOVER"!==(null===(t=i.native.relatedTarget)||void 0===t?void 0:t.tagName)&&this.arcgisHubMapPopoverClear.emit()}_updateSelectedLocation(){this._selected.location=Object.assign(Object.assign({},this._selected.location),{geometries:this.geometryGraphicsLayer.graphics.clone().toArray().map((i=>{var t,e;const s=(null===(t=this._selected.location)||void 0===t?void 0:t.spatialReference)?v(i.geometry,null===(e=this._selected.location)||void 0===e?void 0:e.spatialReference):i.geometry;return Object.assign(Object.assign({},s.toJSON()),{type:s.type})})),extent:this._getExtentForAllGraphics})}get _getCurrentFeaturesCount(){var i,t,e;return(null===(e=null===(t=null===(i=this._selected)||void 0===i?void 0:i.location)||void 0===t?void 0:t.geometries)||void 0===e?void 0:e.length)||0}_updateSelectedLocationExtentToGeometry(){var i,t,e,s,o;const a=new b({spatialReference:new w({wkid:null===(e=null===(t=null===(i=this._selected)||void 0===i?void 0:i.location)||void 0===t?void 0:t.spatialReference)||void 0===e?void 0:e.wkid})}),{xmin:r,ymin:n,xmax:c,ymax:h}=_(null===(o=null===(s=this._selected)||void 0===s?void 0:s.location)||void 0===o?void 0:o.extent);a.addRing([[r,n],[r,h],[c,h],[c,n],[r,n]]),this._selected.location.geometries=[Object.assign(Object.assign({},a.toJSON()),{type:"polygon"})]}async _initializeGraphicsLayer(i=!0){var t,e,s,o;const{_view:a}=this;if(a&&(await a.when(),this.addGeometryGraphicsLayer(),(null===(t=this._selected.location)||void 0===t?void 0:t.geometries)&&(this._addGraphicsToGraphicsLayer(this.geometryGraphicsLayer,this._selected.location.geometries.map((i=>new m({geometry:i,symbol:d[i.type](p.DEFAULT,this.themeWithDefaults[i.type])})))),i))){const i=k(null===(o=null===(s=null===(e=this._selected)||void 0===e?void 0:e.location)||void 0===s?void 0:s.geometries[0])||void 0===o?void 0:o.type);this._currentDrawTools=[i],this._currentActiveDrawTool=i}}addGeometryGraphicsLayer(){this.geometryGraphicsLayer=new c({graphics:[],elevationInfo:{mode:"on-the-ground"}}),this._view.map.add(this.geometryGraphicsLayer)}_addGraphicsToGraphicsLayer(i,t){i.addMany(t)}_destroyLayers(){[this.geometryGraphicsLayer].forEach((i=>{i&&(i.removeAll(),i.destroy())}))}get _getExtentForAllGraphics(){const{geometryGraphicsLayer:i}=this;let t;return i.graphics.forEach((i=>{var e,s;const o=v(i.geometry,null===(s=null===(e=this._selected)||void 0===e?void 0:e.location)||void 0===s?void 0:s.spatialReference);let a=o.extent;!("point"!==o.type||t&&t.contains(o))&&(a=this.pointToExtent(o)),a&&(t=t?t.union(a):a)})),t?L(t):void 0}pointToExtent(i,t=.0025){const{x:e,y:s,spatialReference:o}=i;return new y({xmin:e-t,ymin:s-t,xmax:e+t,ymax:s+t,spatialReference:o})}_resetToolsAndEditState(i=!1){var t,e;this._isEditing=!1,this._mapDrawToolsEl.disableEditOptions=!0,this._mapDrawToolsEl.disablePrimaryOptions=!0,this._editingGraphic=null,(null===(e=null===(t=this._selected.location)||void 0===t?void 0:t.geometries)||void 0===e?void 0:e.length)&&!i||(this._currentDrawTools=this.mapTools,this._currentActiveDrawTool=void 0)}editFeature(){this._isEditing=!0,this._mapDrawToolsEl.geometry=this._editingGraphic.geometry,this._mapDrawToolsEl.disableEditOptions=!1,this._mapDrawToolsEl.disablePrimaryOptions=!1,this.geometryGraphicsLayer.remove(this._editingGraphic),this.arcgisHubMapPopoverClear.emit()}removeFeature(){this._mapDrawToolsEl.forceReset(),this.geometryGraphicsLayer.remove(this._editingGraphic),this._updateSelectedLocation(),this._emitLocationWithFallback(),this.arcgisHubMapPopoverClear.emit(),this._resetToolsAndEditState()}_emitLocationWithFallback(){var i,t,e;const s=this._shouldEditFeatures&&!(null===(e=null===(t=null===(i=this._selected)||void 0===i?void 0:i.location)||void 0===t?void 0:t.geometries)||void 0===e?void 0:e.length);this.arcgisHubLocationPickerUpdate.emit(s?{type:"none"}:this._selected.location)}async clearEditState(){this._destroyLayers(),this.arcgisHubMapPopoverClear.emit(),this._mapDrawToolsEl.forceReset(),this._resetToolsAndEditState(!0),this._selected.location=Object.assign(Object.assign({},this._selected.location),{geometries:[]}),await this._initializeGraphicsLayer(!1),this._emitLocationWithFallback(),this.hubTelemetry.emit(j.dictionary.category.interaction.action.remove.label.location.details.clearAll)}renderEditOptions(){const i=this.intl.t("edit"),t=this.intl.t("delete");return e("calcite-action-pad",{"expand-disabled":!0,layout:"horizontal"},e("calcite-action",{icon:"pencil",onClick:this.editFeature,text:i}),e("calcite-action",{icon:"trash",onClick:this.removeFeature,text:t}))}renderPopovers(){return e("arcgis-wormhole",{styles:{position:"absolute",top:0,left:0}},e("arcgis-hub-map-popover",{target:"location-picker-options",unthemed:!0}))}renderNotice(){var i,t,s,o,a,r;if(this._shouldEditFeatures){const n=!(null===(s=null===(t=null===(i=this._selected)||void 0===i?void 0:i.location)||void 0===t?void 0:t.geometries)||void 0===s?void 0:s.length),c=this._getCurrentFeaturesCount>=this.maxFeaturesCount,h=f(null===(o=this._selected)||void 0===o?void 0:o.location)>this.maxVerticesCount,l=(null===(a=this._selected)||void 0===a?void 0:a.entityType)||"content",d=n||c||h;return e("calcite-notice",{icon:d?"exclamation-mark-triangle":"information",kind:d?"warning":"info",open:!0},e("div",{slot:"title"},n?this.intl.t("emptyLocation.title"):c?this.intl.t("maximumLocations.title"):h?this.intl.t("maximumPoints.title",{currentCount:f(null===(r=this._selected)||void 0===r?void 0:r.location),maxLocations:this.maxVerticesCount}):this.intl.t("populatedLocation.title")),e("div",{slot:"message"},n?this.intl.t("emptyLocation.message",{entityType:this.intl.t(`entityTypes.${l}`)}):c?this.intl.t("maximumLocations.message"):h?this.intl.t("maximumPoints.message"):this.intl.t("populatedLocation.message",{maxLocations:this.maxFeaturesCount})))}}setActiveLocationDrawType(i){const{target:t}=i,e=k(t.dataset.type);this._mapDrawToolsEl.setActiveTool(e),this._currentDrawTools=[e],this._currentActiveDrawTool=e,this.locationTypePopoverElement.open=!1}renderCustomAction(i){var t;const{_currentActiveDrawTool:o,_isEditing:a,_currentDrawTools:r,_drawToolIcons:n,_shouldEditFeatures:c,_getCurrentFeaturesCount:h,maxFeaturesCount:l,maxVerticesCount:d}=this;if("custom"===(null===(t=i.location)||void 0===t?void 0:t.type)){const i=r.map((i=>({type:"rectangle"===i?"extent":i,icon:n[i]}))).map((({type:i,icon:t})=>{var s;return e("calcite-action",{class:{hide:h>=l||f(null===(s=this._selected)||void 0===s?void 0:s.location)>d},"data-type":i,disabled:a,icon:t,key:i,onClick:this.setActiveLocationDrawType,text:this.intl.t(`drawLocationPopover.${i}`),textEnabled:!0})}));return e(s,null,e("calcite-popover",{autoClose:!0,ref:i=>{this.locationTypePopoverElement=i},referenceElement:"trigger-element"},i,e("calcite-action",{class:{hide:!h},"data-type":"reset",icon:"x-circle",key:"reset",onClick:this.clearEditState,text:this.intl.t("drawLocationPopover.clear"),textEnabled:!0})),e("calcite-tooltip",{closeOnClick:!0,label:this.intl.t("drawLocationPopover.tooltip"),placement:"top",referenceElement:"trigger-element"},e("span",null,this.intl.t("drawLocationPopover.tooltip"))),e("calcite-action",{class:{hide:!c},icon:o?n[o]:"pencil-mark-plus",id:"trigger-element",slot:"actions-end"}))}}render(){var i;return e(o,{"data-element":"location-picker",unthemed:!0},e("div",{class:"row"},e("arcgis-hub-map",{basemap:"gray-vector",expand:1.5,extent:this.extent,graphics:this._selectedGraphics},e("arcgis-hub-map-widget-container",{"expand-disabled":!0,scale:"m",view:this._view,"view-position":"top-right"},e("arcgis-hub-map-widget-search",{scale:"m",searchViewModelProperties:{popupEnabled:!1},view:this._view})),e("arcgis-hub-map-widget-container",{"expand-disabled":!0,view:this._view,"view-position":"top-right"},e("arcgis-hub-map-widget-zoom",{view:this._view})),e("arcgis-hub-map-widget-container",{view:this._view,"view-position":"top-right"},e("arcgis-hub-map-widget-draw",{class:{hide:!this._shouldEditFeatures||f(null===(i=this._selected)||void 0===i?void 0:i.location)>this.maxVerticesCount||this._getCurrentFeaturesCount>=this.maxFeaturesCount},"disable-edit-options":!0,"disable-primary-options":!0,disabled:this._isEditing,"enable-map-tips":!0,ref:this._setMapDrawElement,resetOnDisconnect:this.resetDrawingToolsOnDisconnect,tools:this._currentDrawTools,unthemed:!0,view:this._view}),e("arcgis-hub-map-widget-generic",{class:{hide:!this._getCurrentFeaturesCount&&!this._currentActiveDrawTool},"data-type":"reset",icon:"x-circle",onClick:this.clearEditState,text:this.intl.t("drawLocationPopover.clear")})),"none"===this._selectedType?e("div",{class:"arcgis-location-picker-map-overlay"},e("div",{class:"arcgis-location-picker-none-message"},this.intl.t("noneMessage"))):null),e("div",{class:"location-picker__sidepanel"},e("calcite-list",{"selection-mode":"single"},this.options.map(((i,t)=>{var s;return e("calcite-list-item",{description:i.description,key:null===(s=i.location)||void 0===s?void 0:s.type,label:i.label,selected:i.selected,value:t},this.renderCustomAction(i))}))),this.renderNotice())),this.renderPopovers())}static get assetsDirs(){return["locales"]}get el(){return a(this)}static get watchers(){return{_view:["handleViewChange"],options:["onOptionsUpdate"]}}};(function(i,t,e,s){var o,a=arguments.length,r=a<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,e):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(i,t,e,s);else for(var n=i.length-1;n>=0;n--)(o=i[n])&&(r=(a<3?o(r):a>3?o(t,e,r):o(t,e))||r);a>3&&r&&Object.defineProperty(t,e,r)})([n({when(){return this._view}})],C.prototype,"renderPopovers",null),C.style=".sc-arcgis-hub-location-picker-h{display:block}@media (min-width: 640px){.row.sc-arcgis-hub-location-picker{display:flex}.row.sc-arcgis-hub-location-picker{flex-direction:row-reverse}}arcgis-hub-map.sc-arcgis-hub-location-picker{height:430px;position:relative;margin-bottom:1rem;width:100%}@media (min-width: 640px){arcgis-hub-map.sc-arcgis-hub-location-picker{margin-bottom:0px}}arcgis-hub-map-widget-container.hide.sc-arcgis-hub-location-picker{display:none}arcgis-hub-map.sc-arcgis-hub-location-picker .arcgis-location-picker-map-overlay.sc-arcgis-hub-location-picker{position:absolute;top:0px;left:0px;z-index:10;display:flex;height:100%;width:100%;flex-direction:column;justify-content:center;background-color:#0000004d;color:var(--calcite-ui-text-inverse)}.arcgis-location-picker-none-message.sc-arcgis-hub-location-picker{text-align:center}.draw-popover.sc-arcgis-hub-location-picker{width:max-content}.draw-popover.sc-arcgis-hub-location-picker>p.sc-arcgis-hub-location-picker{margin:0px;padding:0.75rem}.location-picker__sidepanel.sc-arcgis-hub-location-picker{display:flex;width:100%;flex-direction:column;justify-content:space-between;background-color:var(--calcite-ui-foreground-3);padding:1rem}@media (min-width: 640px){.location-picker__sidepanel.sc-arcgis-hub-location-picker{max-width:20rem}}calcite-list.sc-arcgis-hub-location-picker{width:100%;background-color:var(--calcite-ui-foreground-3);color:var(--calcite-ui-text-3)}@media (min-width: 640px){calcite-list.sc-arcgis-hub-location-picker{max-width:20rem}}calcite-notice.sc-arcgis-hub-location-picker{width:100%}@media (min-width: 640px){calcite-notice.sc-arcgis-hub-location-picker{max-width:20rem}}";export{C as arcgis_hub_location_picker}