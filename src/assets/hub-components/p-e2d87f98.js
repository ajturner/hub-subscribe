import{i as e}from"./p-6dac87c8.js";import{E as t}from"./p-2d862ad3.js";import{a as i}from"./p-b728aff4.js";import{p as r}from"./p-c8e0e01f.js";function n(n={},u){return function(n,u){var p,T,y;if(!n.schemaVersion||1!==n.schemaVersion)if(e(n.type)){const e=function(e){let i=[];if(e){if(s(e))return console.error("Cannot migrate original stat card where clause. Converting to legacy."),[];i=e.split("AND").map((e=>{let i;if(e.includes(">=")){const{fieldName:r,value:n}=c(e,">=");let l,o=n;n.includes("TIMESTAMP")&&(o=d(n),l="esriFieldTypeDate"),i=f(r,l,t.BETWEEN,[o])}else if(e.includes("<=")){const{fieldName:r,value:n}=c(e,"<=");let l,o=n;n.includes("TIMESTAMP")&&(o=d(n),l="esriFieldTypeDate"),i=f(r,l,t.BETWEEN,[void 0,o])}else if(e.includes("=")&&"1=1"!==e){const{fieldName:r,value:n}=c(e,"="),l=v(n);i=f(r,"esriFieldTypeString",t.IS_EXACTLY,[l])}else if(e.includes(t.LIKE)){let{fieldName:r,value:n}=c(e,t.LIKE);r.includes("UPPER")&&(r=function(e){return e.slice(6,e.length-1)}(r)),n=v(n),n=function(e){return e.replace(/^\%+|\%+$/g,"")}(n),i=f(r,"esriFieldTypeString",t.LIKE,[n])}return i})).filter((e=>!!e))}return i}(n.where),g=!!n.datasetId,{itemId:S,layerId:I}=function(e,t){var i;let n=t.itemId,l=null===(i=t.layerId)||void 0===i?void 0:i.toString();if(e){const e=r(t.datasetId);n=e.itemId,l=e.layerId}return{itemId:n,layerId:l}}(g,n),M=m(null===(p=null==u?void 0:u.links)||void 0===p?void 0:p.siteRelative,I);n={type:"dynamic",cardTitle:n.title,value:"Statistic",dynamicMetric:{itemId:S?[S]:void 0,layerId:I,field:n.statFieldName||(null===(T=n.statField)||void 0===T?void 0:T.name),fieldType:n.statFieldType||(null===(y=n.statField)||void 0===y?void 0:y.type),statistic:n.statType,serviceUrl:o(n.url),expressionSet:e,allowExpressionSet:!!e.length,legacyWhere:s(n.where)?n.where:void 0,sourceLink:M,sourceTitle:null==u?void 0:u.name},serverTimeout:n.timeout,textAlign:a(n.statValueAlign),valueColor:null===n.statValueColor?void 0:n.statValueColor,trailingText:n.trailingText,cardId:n.cardId||i(),allowUnitFormatting:!1,allowLink:!1,allowDynamicLink:l(M,n.hideSource),schemaVersion:1,scale:"l"}}else n.schemaVersion=1;return n}(n,u)}function l(e,t){return!(!e||t)}function o(e){let t=e;return(null==e?void 0:e.lastIndexOf("FeatureServer"))>-1?t=e.slice(0,e.lastIndexOf("FeatureServer")+13):(null==e?void 0:e.lastIndexOf("MapServer"))>-1&&(t=e.slice(0,e.lastIndexOf("MapServer")+9)),t}function a(e){switch(e){case"center":return"center";case"right":return"end";case"left":default:return"start"}}const u=[" OR "," CURRENT_TIMESTAMP"," IS NULL"," is null"];function s(e){let t=!1;return e&&u.map((i=>{e.includes(i)&&(t=!0)})),t}function c(e,t){const i=e.trim().split(t);return{fieldName:i[0].trim(),value:i[1].trim()}}function d(e){return e.split("'")[1].trim().split(" ")[0].trim()}function f(e,t,i,r){const n={name:e};return t&&(n.type=t),{field:n,values:r,relationship:i}}function v(e){return e.replace(/^\'+|\'+$/g,"")}function m(t,i){return t&&!e(i)&&(t=`${t}_${i}`),t&&(t=`${t}?showData=true`),t}export{m as c,n as m}