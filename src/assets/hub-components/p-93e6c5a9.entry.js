import{r as t,c as i,h as e,H as s,a as o}from"./p-d4ba4c14.js";import{i as r}from"./p-be5c5009.js";import{b as a}from"./p-fd260f2d.js";import{d as p}from"./p-8cf4bd83.js";import{M as n}from"./p-3311a06c.js";import{g as l}from"./p-796574a4.js";import{g as d}from"./p-75d6da59.js";import{b as c}from"./p-cea8413b.js";import{i as h}from"./p-df1dc3df.js";import{u}from"./p-9cda128d.js";import{h as m}from"./p-b1a98ae3.js";import{s as g}from"./p-78bc8064.js";import{v}from"./p-85d6867e.js";import"./p-dfe5a97d.js";import"./p-a0deb8c6.js";import"./p-d763eacf.js";import"./p-377e1b5e.js";import"./p-637ea136.js";import"./p-dcdf7b57.js";import"./p-ad325ed1.js";import"./p-00849f08.js";import"./p-992b9d10.js";import"./p-8e7f4c22.js";import"./p-9b205605.js";import"./p-1458dcfd.js";import"./p-b728aff4.js";import"./p-783242bc.js";import"./p-dd26efbb.js";import"./p-d1b12a9c.js";import"./p-6dcae6cd.js";import"./p-3f64a9d9.js";import"./p-2acb70a6.js";import"./p-903ef8af.js";import"./p-52612356.js";import"./p-af59e67b.js";import"./p-dafb2329.js";import"./p-6f931af6.js";import"./p-56b73d71.js";import"./p-3904125b.js";import"./p-b295a5ae.js";import"./p-69555c48.js";import"./p-235bb6ee.js";import"./p-7202c430.js";import"./p-895b662f.js";import"./p-8dbea197.js";import"./p-59fd2498.js";import"./p-90dc0f6f.js";import"./p-31aebb8c.js";import"./p-aa262d60.js";import"./p-ea6de7f6.js";import"./p-24ecdf64.js";import"./p-3363f483.js";import"./p-87582fe0.js";import"./p-7853d817.js";import"./p-16a95e5b.js";import"./p-e43616ff.js";import"./p-ca048216.js";import"./p-4a14259a.js";import"./p-c836a9b6.js";function b(t,i,e,s){return Promise.all(i.map((async i=>{const o=Object.assign({},{id:t,groupId:i},e);s&&(o.owner=s);try{return await u(o)}catch(e){throw Error(`Error unsharing item: ${t} with group: ${i}`)}})))}var f=function(t,i,e,s){var o,r=arguments.length,a=r<3?i:null===s?s=Object.getOwnPropertyDescriptor(i,e):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,i,e,s);else for(var p=t.length-1;p>=0;p--)(o=t[p])&&(a=(r<3?o(a):r>3?o(i,e,a):o(i,e))||a);return r>3&&a&&Object.defineProperty(i,e,a),a};const j=class{constructor(e){t(this,e),this.hubTelemetry=i(this,"hubTelemetry",7),this.entity=void 0,this.context=void 0,this.currentEditGroups=void 0,this.currentViewGroups=void 0,this.workspacePane=void 0,this.supportingTeams=void 0,a(this,"handleEditGroupUpdate","handleViewGroupUpdate","handleGalleryAction")}async componentWillLoad(){await this.fetchExistingSharingGroups(this.entity.id,this.context),this.supportingTeams=l(this.entity,"legacyTeams"),this.intl=await r.loadIntlForComponent(this.element)}get type(){return d(this.entity)||"content"}async fetchExistingSharingGroups(t,i){const e=await c(t,null==i?void 0:i.requestOptions),s=[...e.admin,...e.member,...e.other];this.currentEditGroups=s.reduce(((t,i)=>(h(i)&&t.push(i.id),t)),[]),this.currentViewGroups=s.reduce(((t,i)=>(!h(i)&&t.push(i.id),t)),[])}async handleEditGroupUpdate(t){var i,e;const{added:s,removed:o,updatedList:r}=t.detail,a=[];s&&a.push(p.dictionary.category.content.action.update.label.groups.details.addEditGroups),o&&a.push(p.dictionary.category.content.action.update.label.groups.details.removeEditGroups);try{if(o){const t={authentication:null===(i=this.context)||void 0===i?void 0:i.requestOptions.authentication};await b(this.entity.id,o,t)}await this.shareEntityWithGroups(this.entity,r),this.currentEditGroups=r,a.forEach((t=>{var i;this.hubTelemetry.emit(Object.assign(Object.assign({},t),{response:p.constants.response.SUCCESS,count:null===(i=this.currentEditGroups)||void 0===i?void 0:i.length}))}))}catch(t){null===(e=this.workspacePane)||void 0===e||e.triggerAlert({kind:"danger",title:this.getStringWithFallback(`${this.type}.errorMessage`,this.intl.t("content.errorMessage"))}),console.error(t),a.forEach((t=>{var i;this.hubTelemetry.emit(Object.assign(Object.assign({},t),{response:p.constants.response.FAILURE,count:null===(i=this.currentEditGroups)||void 0===i?void 0:i.length}))}))}}async handleViewGroupUpdate(t){var i,e;const{added:s,removed:o,updatedList:r}=t.detail,a=[];s&&a.push(p.dictionary.category.content.action.update.label.groups.details.addViewGroups),o&&a.push(p.dictionary.category.content.action.update.label.groups.details.removeViewGroups);try{if(o){const t={authentication:null===(i=this.context)||void 0===i?void 0:i.requestOptions.authentication};await b(this.entity.id,o,t)}await this.shareEntityWithGroups(this.entity,r),this.currentViewGroups=r,a.forEach((t=>{var i;this.hubTelemetry.emit(Object.assign(Object.assign({},t),{response:p.constants.response.SUCCESS,count:null===(i=this.currentViewGroups)||void 0===i?void 0:i.length}))}))}catch(t){null===(e=this.workspacePane)||void 0===e||e.triggerAlert({kind:"danger",title:this.getStringWithFallback(`${this.type}.errorMessage`,this.intl.t("content.errorMessage"))}),console.error(t),a.forEach((t=>{var i;this.hubTelemetry.emit(Object.assign(Object.assign({},t),{response:p.constants.response.FAILURE,count:null===(i=this.currentViewGroups)||void 0===i?void 0:i.length}))}))}}async shareEntityWithGroups(t,i){var e;const s={requestOptions:null===(e=this.context)||void 0===e?void 0:e.hubRequestOptions},o={targetEntity:"group",filters:[{predicates:[{id:i}]}]},{results:r}=await m(o,s);await Promise.all(r.map((async i=>{var e;try{await g({id:t.id,groupId:i.id,owner:t.owner,authentication:null===(e=this.context)||void 0===e?void 0:e.session,confirmItemControl:i.isSharedUpdate})}catch(e){throw Error(`Entity: ${t.id} could not be shared with group: ${i.id}`)}})))}get facets(){var t,i,e,s,o,r,a,p;const n=this.context.currentUser.groups.reduce(((t,i)=>("admin"===i.userMembership.memberType&&t.push(i.id),t)),[]),l={label:this.intl.t("groupPicker.facet.label"),key:"from",display:"single-select",operation:"OR",options:[{label:this.intl.t("groupPicker.facet.myGroup"),key:this.intl.t("groupPicker.facet.myGroup"),selected:!0,predicates:[{owner:null===(t=this.context)||void 0===t?void 0:t.currentUser.username}]},{label:this.intl.t("groupPicker.facet.myOrganization"),key:this.intl.t("groupPicker.facet.myOrganization"),selected:!1,predicates:[{orgid:null===(e=null===(i=this.context)||void 0===i?void 0:i.currentUser)||void 0===e?void 0:e.orgId,searchUserAccess:"groupMember",searchUserName:this.entity.owner,isviewonly:!1},{orgid:null===(o=null===(s=this.context)||void 0===s?void 0:s.currentUser)||void 0===o?void 0:o.orgId,id:n}]}]};return(null===(r=this.context)||void 0===r?void 0:r.communityOrgId)&&l.options.push({label:this.intl.t("groupPicker.facet.myCommunity"),key:this.intl.t("groupPicker.facet.myCommunity"),selected:!1,predicates:[{orgid:null===(a=this.context)||void 0===a?void 0:a.communityOrgId,searchUserAccess:"groupMember",searchUserName:this.entity.owner,isviewonly:!1},{orgid:null===(p=this.context)||void 0===p?void 0:p.communityOrgId,id:n}]}),[l]}get createNewGroupsLink(){var t;return`${null===(t=this.context)||void 0===t?void 0:t.portalUrl}/home/groups.html`}get orgOverviewLink(){var t;return`${null===(t=this.context)||void 0===t?void 0:t.portalUrl}/home/organization.html?#overview`}get isEntityOwner(){var t,i;return this.entity.owner===(null===(i=null===(t=this.context)||void 0===t?void 0:t.currentUser)||void 0===i?void 0:i.username)}get canShareToGroups(){var t,i,e;return null===(e=null===(i=null===(t=this.context)||void 0===t?void 0:t.currentUser)||void 0===i?void 0:i.privileges)||void 0===e?void 0:e.includes("portal:user:shareToGroup")}get supportingGroupsQuery(){return{targetEntity:"group",filters:[{predicates:[{id:this.supportingTeams}]}]}}get supportingTeamsActionLinks(){return[{action:"unlinkTeam",label:this.intl.t("supportTeamsRemove"),icon:"x-circle",showLabel:!0}]}handleGalleryAction(t){const{action:i,model:e}=t.detail;"unlinkTeam"===i&&this.unlinkSupportingTeam(e)}async unlinkSupportingTeam(t){var i,e;try{const e=this.entity;e.legacyTeams=this.supportingTeams.filter((i=>i!==t.id)),await v(e,this.context.hubRequestOptions),this.supportingTeams=e.legacyTeams,null===(i=this.workspacePane)||void 0===i||i.triggerAlert({kind:"success",title:this.intl.t("supportingTeamsRemoveSuccess")})}catch(t){console.error(t),null===(e=this.workspacePane)||void 0===e||e.triggerAlert({kind:"danger",title:this.intl.t("supportingTeamsRemoveError")})}}getStringWithFallback(t,i){return this.intl.t(t,void 0,{fallback:i})}renderAddNewPeopleNotice(){return e("calcite-notice",{icon:"lightbulb",kind:"brand",open:!0,width:"full"},e("div",{slot:"title"},this.intl.t("addNewPeopleNotice.title")),e("div",{slot:"message"},this.intl.t("addNewPeopleNotice.message",{orgOverviewLink:(...t)=>e("arcgis-hub-workspace-link",{href:this.orgOverviewLink,target:"_blank",telemetry:p.dictionary.category.navigation.action.external.label.arcGisOnline.details.organization},t)})))}renderSupportingTeams(){const{supportingTeams:t,type:i}=this;if(t&&t.length&&"site"===i)return e("div",null,e("h3",null,this.intl.t("supportingTeams")),e("div",null,this.intl.t("supportingTeamsDesc")),e("arcgis-hub-gallery",{cardActionLinks:this.supportingTeamsActionLinks,context:this.context,layout:"list",limit:100,linkTarget:"workspaceRelative",newTab:!0,onArcgisHubGalleryAction:this.handleGalleryAction,query:this.supportingGroupsQuery,showEmptyState:!1}))}render(){return e(s,{"data-element":"entity-collaborators"},e("arcgis-hub-workspace-pane",{ref:t=>{this.workspacePane=t}},e("h2",{slot:"title"},this.intl.t("collaborators")),e("div",null,e("div",{class:"entity-collaborators__group-sharing-container"},e("p",null,this.getStringWithFallback(`${this.type}.description`,this.intl.t("content.description"))),e("h3",null,this.intl.t("editGroupsTitle")),e("div",null,this.getStringWithFallback(`${this.type}.editGroupsDescription`,this.intl.t("content.editGroupsDescription"))),e("arcgis-hub-group-list-manager",{allowAdd:this.canShareToGroups&&this.isEntityOwner,allowRemove:this.isEntityOwner,groupIds:this.currentEditGroups,metadataMode:"members",onArcgisHubGroupListManagerChanged:this.handleEditGroupUpdate,pickerFacets:this.facets,pickerToggleLabel:this.intl.t("editGroupButtonText"),wellKnownPickerCatalog:"editGroups"}),e("h3",null,this.intl.t("viewGroupsTitle")),e("div",null,this.getStringWithFallback(`${this.type}.viewGroupsDescription`,this.intl.t("content.viewGroupsDescription"))),e("arcgis-hub-group-list-manager",{allowAdd:this.canShareToGroups,allowRemove:this.isEntityOwner,groupIds:this.currentViewGroups,metadataMode:"members",onArcgisHubGroupListManagerChanged:this.handleViewGroupUpdate,pickerFacets:this.facets,pickerToggleLabel:this.intl.t("viewGroupButtonText"),wellKnownPickerCatalog:"viewGroups"})),this.renderSupportingTeams()),e("div",{slot:"side-panel"},this.renderAddNewPeopleNotice())))}static get assetsDirs(){return["locales"]}get element(){return o(this)}};f([n("supportingTeams")],j.prototype,"supportingGroupsQuery",null),f([n()],j.prototype,"supportingTeamsActionLinks",null),j.style=":host{display:block;height:100%}arcgis-hub-group-list-manager{margin-top:1rem}arcgis-hub-gallery{margin-top:1rem}";export{j as arcgis_hub_entity_collaborators}