import{_ as t}from"./p-9b205605.js";import{H as e,e as r,s as n,g as s,i as o,a,p as i}from"./p-1458dcfd.js";import{u,c}from"./p-b728aff4.js";import{e as l,b as p,c as m}from"./p-783242bc.js";import{g as f}from"./p-796574a4.js";import{m as d}from"./p-aa262d60.js";import{s as b,g as h}from"./p-992b9d10.js";import{O,c as y,b as w,a as j}from"./p-6f931af6.js";import{g,b as $}from"./p-8e7f4c22.js";import{j as q}from"./p-85d6867e.js";import{m as v}from"./p-8dbea197.js";import{g as N}from"./p-ea6de7f6.js";import{s as x}from"./p-52612356.js";import{f as D}from"./p-24ecdf64.js";import{s as S,e as A}from"./p-dafb2329.js";import{g as P}from"./p-235bb6ee.js";import{R as U}from"./p-56b73d71.js";import{s as k}from"./p-3363f483.js";const R={org:t=>{const{data:e,stack:r,requestOptions:n}=t,s=r.start("enrichUserOrg");if(e.user.orgId){const o=Object.assign(Object.assign({},n),{portal:`${g(n.portal)}/sharing/rest`});return w(e.user.orgId,o).then((t=>(r.finish(s),{data:Object.assign(Object.assign({},e),{org:t}),stack:r,requestOptions:n}))).catch((e=>((t,e,r)=>{const{data:n,stack:s,requestOptions:o}=e;return s.finish(r,{error:t}),{data:Object.assign(Object.assign({},n),{errors:j(t,n.errors)}),stack:s,requestOptions:o}})(e,t,s)))}return r.finish(s),Promise.resolve({data:Object.assign(Object.assign({},e),{org:null}),stack:r,requestOptions:n})}};async function I(t,e,r){var n;const s={access:t.access,id:t.username,type:"User",name:t.fullName,owner:t.username,summary:t.hasOwnProperty("description")?t.description:void 0,createdDate:new Date(t.created),createdDateSource:"user.created",updatedDate:new Date(t.modified),updatedDateSource:"user.modified",family:"people",links:{self:"not-implemented",siteRelative:"not-implemented",thumbnail:null}};t.memberType&&(s.memberType=t.memberType,s.isGroupOwner=t.isGroupOwner);const o=e.filter(u).map(q),a=v("enrichment",o).filter(u);let i={};a.length&&(i=await function(t,e,r){const n=e.reduce(((t,e)=>{const r=R[e];return r&&t.push(r),t}),[]);return y(n)({data:{user:t},stack:new O,requestOptions:r}).then((t=>t.data))}(t,a,r)),o.forEach((t=>{s[t.prop]=f(i,t.path)}));const c=null===(n=r.authentication)||void 0===n?void 0:n.token;return t.thumbnail&&(s.links.thumbnail=p(r.portal,t,c)),s.links.self=N(s.id,r),s.links.siteRelative=`/people/${s.id}`,s}async function F(t,s){let o;if(t.filters.forEach((t=>{t.predicates.forEach((t=>{const e=f(t,"group");Array.isArray(e)?o=e[0]:"string"==typeof e?o=e:"object"==typeof e&&(o=f(e,"any[0]")||f(e,"all[0]"))}))})),!o)throw new e("portalSearchGroupMembers","Group Id required. Please pass as a predicate in the query.");t.filters=t.filters.map((t=>{const e=["name","memberType","joined"];return t.predicates=t.predicates.map((t=>(t.term&&(t.name=t.term,delete t.term),t))).map((t=>d(t,{},e))).filter((t=>Object.entries(t).length>0)).map(r),t}));const a=n(t);return["num","sortField","sortOrder","include","start"].forEach((t=>{s.hasOwnProperty(t)&&(a[t]=s[t])})),a.groupId=o,a.requestOptions=s.requestOptions,G(a)}async function G(t){const e=Object.assign(Object.assign({},t),t.requestOptions),r=await b(t.groupId,e),n=await Promise.all(r.users.map((e=>async function(t,e=[],r){const n={username:t.username,memberType:t.memberType||"member",access:"private",fullName:null,firstName:null,lastName:null,description:null,orgId:null,groups:[],tags:[],thumbnail:null,created:null,modified:null,isGroupOwner:t.isGroupOwner},s=D($,n),o=await s({username:t.username,authentication:r.authentication,portal:r.portal});return Object.keys(n).forEach((t=>{o.hasOwnProperty(t)&&""!==o[t]&&x(t,o[t],n)})),I(n,["org.name as OrgName",...e],r)}(Object.assign(Object.assign({},e),{isGroupOwner:r.owner.username===e.username}),t.include,t.requestOptions))));return{total:r.total,results:n,hasNext:r.nextStart>-1,next:m(t,r.nextStart,r.total,G)}}async function E(t,s){if(!s.requestOptions)throw new e("portalSearchGroups","options.requestOptions is required.");t.filters=t.filters.map((t=>(t.predicates=t.predicates.map(r),t)));const o=n(t);return["num","sortField","sortOrder","include","start","requestOptions"].forEach((t=>{s.hasOwnProperty(t)&&(o[t]=s[t])})),s.requestOptions.authentication?o.authentication=s.requestOptions.authentication:o.portal=s.requestOptions.portal,L(o)}async function L(t){const e=await S(t),r=await Promise.all(e.results.map((e=>async function(t,e=[],r){return A(t,e,r)}(e,t.include,t.requestOptions))));return{total:e.total,results:r,hasNext:e.nextStart>-1,next:m(t,e.nextStart,e.total,L)}}function T(t,s,o){if(!s.requestOptions)throw new e(o,"requestOptions: IHubRequestOptions is required.");if(!s.requestOptions.authentication)throw new e(o,"requestOptions must pass authentication.");const a=c(t);a.filters=a.filters.map((t=>(t.predicates=t.predicates.map(r),t)));const i=n(a);return["num","sortField","sortOrder","include","start","requestOptions"].forEach((t=>{s.hasOwnProperty(t)&&(i[t]=s[t])})),i.authentication=s.requestOptions.authentication,i}function B(t,e){const r=T(t,e,"searchPortalUsersLegacy");return M(Object.assign(Object.assign({},r),{include:["org.name as OrgName",...r.include||[]]}))}function C(t,e){return M(T(t,e,"searchPortalUsers"))}function H(t,e){return W(T(t,e,"searchCommunityUsers"))}function Q(t,e){return Promise.all(e.results.map((e=>function(t,e=[],r){return I(t,e,r)}(e,t.include,t.requestOptions))))}async function M(t){const e=await(r=t,P(r,"user"));var r;const n=await Q(t,e);return{total:e.total,results:n,hasNext:e.nextStart>-1,next:m(t,e.nextStart,e.total,M)}}async function W(t){const e=await(r=t,P(r,"communityUser"));var r;const n=await Q(t,e);return{total:e.total,results:n,hasNext:e.nextStart>-1,next:m(t,e.nextStart,e.total,W)}}function _(t,e){return`${e.api.url}/collections/${t.collection||"all"}`}async function z(t,e,r){var n;const s=c(e),a=new URL(r.site).hostname;a!==new URL(t).hostname&&(s.target=a);const i=t+function(t){const e=Object.entries(t).filter((([t,e])=>!o(e))).map((([t,e])=>`${t}=${encodeURIComponent(e)}`)).join("&");return e&&`?${e}`}(s),u=(null===(n=r.requestOptions)||void 0===n?void 0:n.fetch)||fetch,l=await u(i,{method:"GET"});if(!l.ok)throw new U(l.statusText,i,l.status);return l.json()}function J(t){const e=t.operation||"OR";return`(${t.predicates.map(K).filter(Y).join(` ${e} `)})`}function K(t){return`(${Object.entries(t).filter((([t,e])=>"term"!==t&&"bbox"!==t&&!o(e))).reduce(((t,[e,r])=>{let n;var s;return"string"==typeof r||"boolean"==typeof r?n=V(e,r):Array.isArray(r)?n=function(t,e){return`${t} IN (${e.map(X).join(", ")})`}(e,r):(s=r,n=Number.isInteger(s.from)&&Number.isInteger(s.to)?function(t,e){return`${t} BETWEEN ${e.from} AND ${e.to}`}(e,r):function(t,e){return[function(t,e){let r;return Array.isArray(e)?r=`${t} IN (${e.map(X).join(", ")})`:e&&(r=V(t,e)),r}(t,e.any),function(t,e){let r;return Array.isArray(e)?r=e.map((e=>V(t,e))).join(" AND "):e&&(r=V(t,e)),r}(t,e.all),function(t,e){let r;return e&&(r=`${t} NOT IN (${(Array.isArray(e)?e:[e]).map(X).join(", ")})`),r}(t,e.not)].filter((t=>!!t)).join(" AND ")}(e,r)),t.push(n),t}),[]).join(" AND ")})`}function V(t,e){return`${t}=${"string"==typeof e?X(e):e}`}function X(t){return/\s/.test(t)?`'${t}'`:t}function Y(t){return"()"!==t}async function Z(t,e){const r=`${_(t,e)}/items`,n=function(t,e){return{filter:function(t){return t.filters.map(J).filter(Y).join(" AND ")}(t),token:f(e,"requestOptions.authentication.token"),limit:e.num,startindex:e.start,q:function(t){const e=s("term",t.filters);return null==e?void 0:e.term}(t),sortBy:function(t){const{sortField:e,sortOrder:r}=t;let n;return e&&(n="desc"===r?`-properties.${e}`:`properties.${e}`),n}(e),bbox:function(t){const e=s("bbox",t.filters);return null==e?void 0:e.bbox}(t)}}(t,e);return async function(t,e,r){const n=await Promise.all(t.features.map((t=>async function(t,e,r){const n=t.properties,s=await a(n,e,r);return s.source=t.properties.source,s.license=t.properties.license,s}(t,r.include,r.requestOptions)))),s=function(t,e,r){const n=t.links.find((t=>"next"===t.rel));let s=()=>null;return n&&(s=()=>{const t=+new URL(n.href).searchParams.get("startindex"),s=Object.assign(Object.assign({},r),{start:t});return Z(e,s)}),s}(t,e,r),o=t.links.find((t=>"next"===t.rel));return{total:t.numberMatched,results:n,hasNext:!!o,next:s}}(await z(r,n,e),t,e)}async function tt(t,e){var r;return(null===(r=e.aggFields)||void 0===r?void 0:r.length)?async function(t,e){const r=`${_(t,e)}/aggregations`,n=function(t,e){return{aggregations:`terms(fields=(${e.aggFields.join()}))`,openData:function(t){const e=s("openData",t.filters);return null==e?void 0:e.openData}(t),token:f(e,"requestOptions.authentication.token")}}(t,e);return{total:0,results:[],hasNext:!1,next:()=>null,aggregations:(await z(r,n,e)).aggregations.aggregations.map((t=>({mode:"terms",field:t.field,values:t.aggregations.map((t=>({value:t.label,count:t.value})))})))}}(t,e):Z(t,e)}const et=async(t,r)=>{const n=((t,r)=>{if(!t.requestOptions)throw new e("hubSearchChannels","options.requestOptions is required");const n={},s={sortField:"sortBy",term:"name"};["num","start","sortField","sortOrder"].forEach((e=>{if(t.hasOwnProperty(e)){const{[e]:r=e}=s,o=r,a=((t,e)=>{let r=e;return"sortOrder"===t?r=null==e?void 0:e.toUpperCase():"sortBy"===t&&(r={created:"createdAt",modified:"updatedAt",title:null}[e]),r})(o,t[e]);r&&a&&(n[o]=a)}}));const o={},a=["access","groups","name"];return r.filters.forEach((t=>{t.predicates.forEach((t=>{Object.keys(t).forEach((e=>{const{[e]:r=e}=s;a.includes(r)&&(o[r]=[...o[r]||[],t[e]])}))}))})),Object.assign(Object.assign({},t.requestOptions),{data:Object.assign(Object.assign({},n),o)})})(r,t);return(async(t,e,r)=>{const{total:n,items:s,nextStart:o}=t;return{total:n,results:await Promise.all(s.map((async t=>{var e;return Object.assign(Object.assign({},t),{id:t.id,name:t.name,createdDate:new Date(t.createdAt),createdDateSource:"channel",updatedDate:new Date(t.updatedAt),updatedDateSource:"channel",type:"channel",access:t.access,family:"channel",owner:t.creator,links:{thumbnail:null,self:null,siteRelative:null},includes:{groups:(null===(e=r.include)||void 0===e?void 0:e.includes("groups"))?await Promise.all(t.groups.map((async t=>{let e;try{e=await h(t,r.requestOptions)}catch(r){e=null,console.warn(`Cannot fetch group enhancement for id = ${t}`,r)}return e}))):[]}})}))),hasNext:o>-1,next:()=>et(e,Object.assign(Object.assign({},r),{start:o}))}})(await k(n),t,r)};async function rt(r,n){if(!r)throw new e("hubSearch","Query is required.");if(!Array.isArray(r.filters))throw new e("hubSearch","Query must have a filters array.");if(!r.filters.length&&!r.collection)throw new e("hubSearch","Query must contain at least one Filter or a collection.");if(!n.requestOptions)throw new e("hubSearch","requestOptions: IHubRequestOptions is required.");n.include||(n.include=[]);const s=r.targetEntity,{requestOptions:o}=n,a=t(n,["requestOptions"]),u=c(a);u.requestOptions=o,u.api=function(t,e){const{api:r,requestOptions:{portal:n}}=e;let s;return s=r?l(r):function(t,e){const{requestOptions:{isPortal:r}}=e;return"channel"===t&&!r}(t,e)?{type:"arcgis-hub",url:null}:function(t,e){const{site:r,requestOptions:{isPortal:n}}=e;return"item"===t&&!!r&&!n}(t,e)?function(t){return{type:"arcgis-hub",url:`https://${new URL(t.requestOptions.hubApiUrl).hostname}/api/search/v1`}}(e):{type:"arcgis",url:n},s}(s,u);const p=f({arcgis:{item:i,group:E,user:B,portalUser:C,communityUser:H,groupMember:F},"arcgis-hub":{item:tt,channel:et}},`${u.api.type}.${s}`);if(!p)throw new e("hubSearch",`Search via "${s}" filter against "${u.api.type}" api is not implemented. Please ensure "targetEntity" is defined on the query.`);return p(c(r),u)}export{rt as h}