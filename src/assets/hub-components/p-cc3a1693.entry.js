import{r as i,c as t,h as e,F as s,H as a,a as o}from"./p-d4ba4c14.js";import{b as h}from"./p-fd260f2d.js";import{i as r}from"./p-be5c5009.js";import{d as n}from"./p-8cf4bd83.js";import"./p-dfe5a97d.js";const l=class{constructor(e){i(this,e),this.arcgisImageUploadCancel=t(this,"arcgisImageUploadCancel",7),this.arcgisImageUploadError=t(this,"arcgisImageUploadError",7),this.arcgisImageUploadSave=t(this,"arcgisImageUploadSave",7),this.hubTelemetry=t(this,"hubTelemetry",7),this.imageFormat="png",this.fileName="",this.triggerErrorState=()=>{this.hasError=!0,setTimeout((()=>{this.resetErrorState()}),3e3)},this.resetErrorState=()=>{this.hasError=!1},this.handleCancel=()=>{this.arcgisImageUploadCancel.emit()},this.handleChooseDiffClick=()=>{this.activeStep="file",this.previewSrc="",this.editExisting=!1},this.handleSaveClick=async()=>{if("file"===this.activeStep)return;this.saving=!0;const i=await this.getCanvasImage();this.arcgisImageUploadSave.emit(i),this.hubTelemetry.emit(n.dictionary.category.interaction.action.add.label.image),this.inline&&this.resetState()},this.modalTitle=void 0,this.sizeDescription=void 0,this.zoomToFit=!0,this.maxWidth=300,this.maxHeight=300,this.fillBackground=!1,this.active=void 0,this.height=window.innerWidth<412?200:300,this.aspectRatio=1,this.inline=!1,this.previewSrc=void 0,this.saving=!1,this.editExisting=!1,this.isModified=!1,this.activeStep="file",this.hasError=!1,h(this,"handleCancel","handleChooseDiffClick","handleSaveClick","getEditStepRef","getCanvasRef")}get _messageOverrides(){return{close:this.intl.t("close")}}async componentWillLoad(){this.intl=await r.loadIntlForComponent(this.el)}handleFileChange(i){const{fileName:t,dataURL:e}=i.detail;this.fileName=t,this.previewSrc=e,this.activeStep="edit",this.resetErrorState()}handleInvalidFile(){this.arcgisImageUploadError.emit("invalid file type."),this.triggerErrorState()}handleImageChange(){this.isModified=!0}handleActiveChange(){this.active||this.resetState()}resetState(){this.activeStep="file",this.saving=!1,this.isModified=!1,this.previewSrc="",this.editExisting=!1,this.resetErrorState()}dataURIToBlob(i){const t=atob(i.split(",")[1]),e=i.split(",")[0].split(":")[1].split(";")[0],s=new ArrayBuffer(t.length),a=new Uint8Array(s);for(let i=0;i<t.length;i++)a[i]=t.charCodeAt(i);return new Blob([s],{type:e})}drawImage({selectionX:i,selectionY:t,selectionWidth:e,selectionHeight:s,canvasWidth:a,canvasHeight:o,minWidth:h,minHeight:r,drawDimensions:n},l,d,c){this.canvasEl.width=a<h?h:a*l,this.canvasEl.height=o<r?r:o*l,this.maxWidth&&this.canvasEl.width>this.maxWidth&&(this.canvasEl.width=this.maxWidth),this.maxHeight&&this.canvasEl.height>this.maxHeight&&(this.canvasEl.height=this.maxHeight);const m=n.left*this.canvasEl.width,p=n.top*this.canvasEl.height,g=n.width*this.canvasEl.width,u=n.height*this.canvasEl.height;this.fillBackground&&(c.fillStyle="#efefef",c.fillRect(0,0,this.canvasEl.width,this.canvasEl.height)),c.drawImage(d,i,t,e,s,m,p,g,u);const f=this.canvasEl.toDataURL("image/png");return{base64:f,blob:this.dataURIToBlob(f)}}async getScaledImageData(i){const t=this.canvasEl.getContext("2d"),e=await this.editStepEl.getDrawParameters();let s;function a(){return t.clearRect(0,0,this.canvasEl.width,this.canvasEl.height),this.drawImage(e,1600/i.width,i,t)}try{s=this.drawImage(e,1,i,t),(s.blob.size>1e7||0===s.blob.size)&&(s=a())}catch(i){"NS_ERROR_FAILURE"!==i.name?this.arcgisImageUploadError.emit("unable to save the image provided."):s=a()}return{blob:null==s?void 0:s.blob,base64:null==s?void 0:s.base64,format:this.imageFormat,fileName:this.fileName}}getCanvasImage(){return new Promise((i=>{const t=new Image;this.previewSrc.indexOf("arcgis.com")>-1&&(t.crossOrigin="Anonymous"),t.onload=()=>{Math.abs(this.aspectRatio-t.width/t.height)<.01&&!this.isModified?i({blob:this.dataURIToBlob(this.previewSrc),base64:this.previewSrc,format:this.imageFormat,fileName:this.fileName}):i(this.getScaledImageData(t))},t.src=this.previewSrc}))}getEditStepRef(i){this.editStepEl=i}getCanvasRef(i){this.canvasEl=i}renderButtons(){const i=e(s,null,"edit"===this.activeStep&&e("calcite-button",{appearance:"transparent",disabled:this.saving,"icon-start":"chevron-left",onClick:this.handleChooseDiffClick,slot:"back",width:this.inline?"auto":"full"},this.intl.t("chooseDiff")),e("calcite-button",{appearance:"outline",class:{hide:this.inline},disabled:this.saving,onClick:this.handleCancel,slot:"secondary",width:"full"},this.intl.t("cancel")),e("calcite-button",{appearance:"solid",class:{hide:this.inline&&"file"===this.activeStep},loading:this.saving,onClick:this.handleSaveClick,slot:"primary",width:this.inline?"auto":"full"},this.intl.t("done")));return this.inline?e("div",{class:"button-container"},i):i}renderContent(){return e(s,null,e("h3",{"aria-label":this.modalTitle,class:"image-upload__title",id:"image-upload-modal-title",slot:"header"},this.modalTitle),e("div",{class:{"image-upload__content":!0,error:this.hasError},slot:"content"},"file"===this.activeStep&&e("div",null,e("arcgis-hub-image-upload-file-step",{sizeDescription:this.sizeDescription})),"edit"===this.activeStep&&e("arcgis-hub-image-upload-edit-step",{aspectRatio:this.aspectRatio,height:this.height,previewSrc:this.previewSrc,ref:this.getEditStepRef,zoomToFit:this.zoomToFit}),"edit"===this.activeStep&&e("canvas",{class:"image-upload__canvas",ref:this.getCanvasRef})),this.renderButtons())}render(){return e(a,{"data-element":"image-upload"},this.inline?e(s,null,this.renderContent()):e("calcite-modal",{"aria-labelledby":"image-upload-modal-title","aria-modal":"true",messageOverrides:this._messageOverrides,onCalciteModalClose:this.handleCancel,open:this.active,outsideCloseDisabled:!0,role:"dialog",width:"m"},this.renderContent()))}static get assetsDirs(){return["locales"]}get el(){return o(this)}static get watchers(){return{active:["handleActiveChange"]}}};l.style='.image-upload__title{margin-bottom:0px;font-size:var(--calcite-font-size-2);line-height:1.5rem}.image-upload__content{transition:all 200ms ease-in-out;border:1px solid var(--calcite-ui-border-3);box-sizing:border-box;background-color:var(--calcite-ui-background);padding-left:2rem;padding-right:2rem;padding-top:1rem;padding-bottom:1.5rem}.image-upload__content--with-map{min-height:400px}.image-upload__content--no-padding{padding:0px}.image-upload__canvas{left:-10000px;visibility:hidden;position:fixed}.or-container{margin-top:1rem;margin-bottom:1rem;text-align:center;font-weight:var(--calcite-font-weight-medium)}.or-container:before,.or-container:after{content:"";border-top:solid 1px var(--calcite-ui-border-input);width:15%;height:1px;z-index:1;display:inline-block;vertical-align:middle}.or-wrapper{padding-left:0.5rem;padding-right:0.5rem}.image-upload__from-map-button{border:1px solid var(--calcite-ui-foreground-3);background-color:var(--calcite-ui-foreground-1);padding:1rem;text-align:center}.image-upload__from-map-button:hover{border:1px solid var(--calcite-ui-brand)}.image-upload__from-map-title{display:inline-block}.from-map-title-wrapper{display:flex;align-items:center}.from-map-icon{margin-right:0.5rem}.image-upload__from-map-desc{margin:0px;font-size:var(--calcite-font-size-1);line-height:1.5rem}.hide{display:none}.button-container{margin-top:0.5rem;display:flex;width:100%;flex-direction:row;justify-content:space-between;padding-top:1.25rem}.error{background-color:#FFF1EF;border-color:var(--calcite-ui-danger)}';export{l as arcgis_hub_image_upload}