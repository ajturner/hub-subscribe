import{r as i,c as t,h as e,F as s,H as o,a as r}from"./p-d4ba4c14.js";import{b as l}from"./p-fd260f2d.js";import{g as n,a as p,E as d}from"./p-2d862ad3.js";import{g as a}from"./p-81dd3f52.js";import{i as u}from"./p-be5c5009.js";import{i as c}from"./p-6dac87c8.js";import{a as h}from"./p-b728aff4.js";import"./p-e65c0b02.js";import"./p-ac8be5fd.js";import"./p-85d6867e.js";import"./p-a0deb8c6.js";import"./p-dd26efbb.js";import"./p-d1b12a9c.js";import"./p-796574a4.js";import"./p-dcdf7b57.js";import"./p-6dcae6cd.js";import"./p-637ea136.js";import"./p-3f64a9d9.js";import"./p-377e1b5e.js";import"./p-2acb70a6.js";import"./p-6f931af6.js";import"./p-56b73d71.js";import"./p-3904125b.js";import"./p-52612356.js";import"./p-af59e67b.js";import"./p-b295a5ae.js";import"./p-cea8413b.js";import"./p-d763eacf.js";import"./p-ad325ed1.js";import"./p-8e7f4c22.js";import"./p-69555c48.js";import"./p-8dbea197.js";import"./p-7202c430.js";import"./p-75d6da59.js";import"./p-90dc0f6f.js";import"./p-59fd2498.js";import"./p-16a95e5b.js";import"./p-e43616ff.js";import"./p-ca048216.js";import"./p-4a14259a.js";import"./p-235bb6ee.js";import"./p-783242bc.js";import"./p-903ef8af.js";import"./p-c836a9b6.js";import"./p-58cf73b6.js";import"./p-7b082f5d.js";import"./p-9646abb2.js";import"./p-bded806b.js";import"./p-87582fe0.js";import"./p-8ccaf06d.js";import"./p-9b205605.js";import"./p-c8e0e01f.js";import"./p-97274a47.js";import"./p-30a7cbb2.js";import"./p-10274eb9.js";import"./p-dafb2329.js";import"./p-992b9d10.js";import"./p-895b662f.js";const v=class{constructor(e){i(this,e),this.arcgisCompositeExpressionSetFieldChange=t(this,"arcgisCompositeExpressionSetFieldChange",7),this.context=void 0,this.values={},this.fields=[],this.internalValues=void 0,this._schema=void 0,this._uiSchema=void 0,this.expressions=[],l(this,"translationFunc","handleEditorChangeEvent","handleAddExpression","handleDeleteExpression")}async componentWillLoad(){this.intl=await u.loadIntlForComponent(this.element),this.values&&(this.expressions=this.repairExpressionsFromMigration(this.values),this.internalValues=this.transformExpressionsToSchemaValues(this.expressions)),this._uiSchema=n(this.uiSchemaElements),this._schema=p(this.schemaProperties)}get schemaProperties(){var i;return null===(i=this.expressions)||void 0===i?void 0:i.reduce(((i,t)=>{var e,s,o,r,l;if(t){const n=null===(e=null==t?void 0:t.field)||void 0===e?void 0:e.type,p={type:"string",enum:[...null===(s=this.fields)||void 0===s?void 0:s.map((i=>i.name)),""]};if(i=Object.assign(Object.assign({},i),{[`combobox-${t.key}`]:p}),n){const e=this.intl.t(null==t?void 0:t.relationship),s={type:"string",default:e,enum:[e]};let p;if(i=Object.assign(Object.assign({},i),{[`select-${t.key}`]:s}),p="esriFieldTypeString"===n&&(null===(l=null===(r=null===(o=null==t?void 0:t.field)||void 0===o?void 0:o.domain)||void 0===r?void 0:r.codedValues)||void 0===l?void 0:l.length)?{type:"string",enum:t.field.domain.codedValues.map((i=>i.code))}:"esriFieldTypeString"===n||"esriFieldTypeDate"===n?{type:"string"}:{type:"number"},i=Object.assign(Object.assign({},i),{[`value-1-${t.key}`]:p}),"esriFieldTypeString"!==n){const e={type:"esriFieldTypeDate"===n?"string":"number"};i=Object.assign(Object.assign({},i),{[`value-2-${t.key}`]:e})}}}return i}),{})}get uiSchemaElements(){var i;return null===(i=this.expressions)||void 0===i?void 0:i.reduce(((i,t)=>{var e,s,o,r,l,n,p;if(t){const d=[],u=null===(e=null==t?void 0:t.field)||void 0===e?void 0:e.type,c={scope:`/properties/combobox-${t.key}`,type:"Control",label:this.intl.t("selectAttribute"),options:{control:"hub-field-input-combobox",items:null===(s=this.fields)||void 0===s?void 0:s.map((i=>({value:i.name,label:i.name,icon:a(i.type)}))),allowCustomValues:!1,selectionMode:"single",overlayPositioning:"fixed"}};if(d.push(c),u){const i={scope:`/properties/select-${t.key}`,type:"Control",label:this.intl.t("filterType"),options:{control:"hub-field-input-select",disabled:!0}};d.push(i);let e,s={};if("esriFieldTypeString"===u?(e=this.intl.t("filterValue"),s=(null===(l=null===(r=null===(o=null==t?void 0:t.field)||void 0===o?void 0:o.domain)||void 0===r?void 0:r.codedValues)||void 0===l?void 0:l.length)?{control:"hub-field-input-select",labels:null===(p=null===(n=null==t?void 0:t.field)||void 0===n?void 0:n.domain)||void 0===p?void 0:p.codedValues.map((i=>i.name))}:{control:"hub-field-input-input"}):"esriFieldTypeDate"===u?(e=this.intl.t("startingDate"),s={control:"hub-field-input-date",overlayPositioning:"fixed"}):(e=this.intl.t("startingValue"),s={control:"hub-field-input-input",type:"number"}),d.push({scope:`/properties/value-1-${t.key}`,type:"Control",label:e,options:s}),"esriFieldTypeString"!==u){let i={};i="esriFieldTypeDate"===u?{control:"hub-field-input-date",overlayPositioning:"fixed"}:{control:"hub-field-input-input",type:"number"};const e=this.intl.t("esriFieldTypeDate"===u?"endingDate":"endingValue");d.push({scope:`/properties/value-2-${t.key}`,type:"Control",label:e,options:i})}}const h={type:"Section",label:this.intl.t("attributeFilter"),options:{section:"block",collapsible:!1,open:!0,actions:[{alignment:"end",icon:"trash",key:t.key,label:this.intl.t("deleteFilter"),onClick:this.handleDeleteExpression,scale:"s",textEnabled:!0}]},elements:d};i=[...i,h]}return i}),[])}repairExpressionsFromMigration(i){return i.map((i=>{var t,e;if(i.key||(i.key=h("expression-")),!(null===(t=i.field)||void 0===t?void 0:t.type)&&(null===(e=i.field)||void 0===e?void 0:e.name)){const t=i.field.name,e=this.fields.find((i=>i.name===t));i.field=e}return i}))}transformExpressionsToSchemaValues(i){return i.reduce(((i,t)=>{const{key:e,values:s,field:o}=t;return Object.assign(Object.assign({},i),{[`combobox-${e}`]:null==o?void 0:o.name,[`value-1-${e}`]:s[0],[`value-2-${e}`]:s[1]})}),{})}handleEditorChangeEvent(i){i.stopImmediatePropagation(),i.stopPropagation();const{valid:t,values:e}=i.detail;this.updateExpressionsOnChange(this.expressions,e,this.fields),this.isValid=t,this.internalValues=e,t&&this.arcgisCompositeExpressionSetFieldChange.emit(this.expressions)}updateExpressionsOnChange(i,t,e){let s=!1;const o=i.reduce(((i,o)=>{var r,l,n;let p={key:o.key,values:[]};const d=t[`combobox-${null==o?void 0:o.key}`];return d&&(p=this.updateExpressionField(p,d,e),p=this.updateExpressionRelationship(p),p=this.updateExpressionValues(p,o,t)),((null===(r=null==p?void 0:p.field)||void 0===r?void 0:r.name)!==(null===(l=null==o?void 0:o.field)||void 0===l?void 0:l.name)||""==d&&void 0!==(null===(n=o.field)||void 0===n?void 0:n.name))&&(s=!0),[...i,p]}),[]);this.expressions=o,s&&(this.updateSchema(),this.updateUiSchema())}updateExpressionField(i,t,e){const s=e.find((i=>i.name===t));return s&&(i.field=s),i}updateExpressionRelationship(i){var t;return i.relationship=i.relationship="esriFieldTypeString"===(null===(t=null==i?void 0:i.field)||void 0===t?void 0:t.type)?d.IS_EXACTLY:d.BETWEEN,i}updateExpressionValues(i,t,e){var s,o;(null===(s=null==i?void 0:i.field)||void 0===s?void 0:s.name)!==(null===(o=null==t?void 0:t.field)||void 0===o?void 0:o.name)&&(e[`value-1-${null==i?void 0:i.key}`]=void 0,e[`value-2-${null==i?void 0:i.key}`]=void 0);const r=e[`value-1-${null==i?void 0:i.key}`],l=e[`value-2-${null==i?void 0:i.key}`],n=[];return c(r)||(n[0]=r),c(l)||(n[1]=l),i.values=n,i}translationFunc(i,t,e){return this.intl.t(i,t,e)}updateSchema(){this._schema=p(this.schemaProperties)}updateUiSchema(){this._uiSchema=n(this.uiSchemaElements)}handleAddExpression(){var i;const t={values:[],key:h("expression-")};null===(i=this.expressions)||void 0===i||i.push(t),this.updateSchema(),this.updateUiSchema()}handleDeleteExpression(i){const t=i.target,e=null==t?void 0:t.getAttribute("data-key");this.expressions=this.expressions.reduce(((i,t)=>(t.key!==e&&(i=[...i,t]),i)),[]),this.updateSchema(),this.updateUiSchema(),this.arcgisCompositeExpressionSetFieldChange.emit(this.expressions)}resetExpressions(i){const t=this.expressions.length;this.expressions=this.expressions.filter((t=>i.find((i=>{var e,s;return i.name===(null===(e=null==t?void 0:t.field)||void 0===e?void 0:e.name)&&i.type===(null===(s=null==t?void 0:t.field)||void 0===s?void 0:s.type)})))),this.updateSchema(),this.updateUiSchema(),this.expressions.length!==t&&this.arcgisCompositeExpressionSetFieldChange.emit(this.expressions)}renderExpressionSet(){if(this.fields.length)return e(s,null,e("arcgis-configuration-editor",{context:this.context,onArcgisConfigurationEditorChange:this.handleEditorChangeEvent,schema:this._schema,t:this.translationFunc,uiSchema:this._uiSchema,values:this.internalValues||this.values}),e("calcite-button",{appearance:"outline-fill",color:"blue",iconStart:"filter",onClick:this.handleAddExpression,round:!0},this.intl.t("addFilter")))}render(){return e(o,null,this.renderExpressionSet())}static get assetsDirs(){return["locales"]}get element(){return r(this)}static get watchers(){return{context:["updateUiSchema"],fields:["resetExpressions"]}}};v.style="arcgis-configuration-editor{margin-top:0.5rem;margin-bottom:0.5rem}";export{v as hub_composite_input_expression_set}